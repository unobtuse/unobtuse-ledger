<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Plaid OAuth</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .instructions {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
    <script>
        // Extract OAuth state from URL hash if present
        (function() {
            const hash = window.location.hash.substring(1);
            const hashParams = new URLSearchParams(hash);
            const stateParam = hashParams.get('state');
            const code = hashParams.get('code');
            
            if (stateParam && code) {
                try {
                    // State is base64 encoded JSON
                    const stateData = JSON.parse(atob(stateParam));
                    const oauthStateId = stateData.oauth_state_id;
                    
                    if (oauthStateId) {
                        // Redirect to our callback with the OAuth state ID
                        const callbackUrl = '/accounts/oauth-callback?oauth_state_id=' + encodeURIComponent(oauthStateId);
                        window.location.href = callbackUrl;
                        return;
                    }
                } catch (e) {
                    console.error('Failed to parse OAuth state:', e);
                }
            }
            
            // If no auto-redirect, show manual input form
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('oauthForm');
                const input = document.getElementById('oauthStateId');
                
                // Try to extract from URL if user pasted Plaid OAuth URL
                const urlParams = new URLSearchParams(window.location.search);
                const oauthStateId = urlParams.get('oauth_state_id');
                if (oauthStateId) {
                    input.value = oauthStateId;
                    form.submit();
                }
                
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    let stateId = input.value.trim();
                    
                    // If user pasted full Plaid OAuth URL, extract state from it
                    if (stateId.includes('cdn.plaid.com') || stateId.includes('oauth.html')) {
                        try {
                            const url = new URL(stateId);
                            const hash = url.hash.substring(1);
                            const hashParams = new URLSearchParams(hash);
                            const stateParam = hashParams.get('state');
                            
                            if (stateParam) {
                                // Decode base64 state
                                const stateData = JSON.parse(atob(stateParam));
                                stateId = stateData.oauth_state_id;
                            }
                        } catch (e) {
                            console.error('Failed to parse URL:', e);
                            alert('Could not extract OAuth state from URL. Please paste just the oauth_state_id.');
                            return;
                        }
                    }
                    
                    if (stateId) {
                        window.location.href = '/accounts/oauth-callback?oauth_state_id=' + encodeURIComponent(stateId);
                    }
                });
            });
        })();
    </script>
</head>
<body>
    <h1>Complete Plaid Account Linking</h1>
    
    <div class="instructions">
        <h3>If you were redirected here automatically:</h3>
        <p>You should be redirected to complete the account linking process. If not, please wait a moment.</p>
    </div>
    
    <div class="instructions">
        <h3>If you're on Plaid's OAuth page:</h3>
        <ol>
            <li>Look at the URL in your browser's address bar</li>
            <li>Find the <code>state</code> parameter in the URL hash (after #)</li>
            <li>Copy the entire URL and paste it below, or extract the <code>oauth_state_id</code> from the state parameter</li>
            <li>Click "Complete Linking" to finish the process</li>
        </ol>
        
        <form id="oauthForm">
            <label for="oauthStateId">OAuth State ID (or paste full Plaid OAuth URL):</label>
            <input type="text" id="oauthStateId" name="oauth_state_id" placeholder="Paste OAuth state ID or full URL here">
            <button type="submit">Complete Linking</button>
        </form>
    </div>
    
    <p><a href="/accounts">‚Üê Back to Accounts</a></p>
</body>
</html>

